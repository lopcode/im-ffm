#!/usr/bin/env bash
set -eou pipefail

# check imagemagick 7 is installed
echo "Checking if ImageMagick 7 is installed..."
magick --version | grep --quiet "ImageMagick 7" || (echo "ImageMagick 7 not installed" && exit 1)

# check at least JDK 22 used
echo "Checking JDK version >= 22..."
java --version | grep --quiet "build 22" || (echo "Not using JDK 22 or above" && exit 1)

# check if jextract is installed
# https://jdk.java.net/jextract/
echo "Checking jextract exists..."
JEXTRACT_DOWNLOAD_URL=https://download.java.net/java/early_access/jextract/22/5/openjdk-22-jextract+5-33_macos-aarch64_bin.tar.gz
JEXTRACT_ZIP_CHECKSUM_SHA256=2a4411c32aedb064c3e432eb8a2791e6e60fea452330c71386f6573dc4c9c850
JEXTRACT_DOWNLOAD_PATH=jextract-22
"$JEXTRACT_DOWNLOAD_PATH"/bin/jextract --version || (echo "Downloading jextract..." \
&& curl --output jextract.tar.gz https://download.java.net/java/early_access/jextract/22/5/openjdk-22-jextract+5-33_macos-aarch64_bin.tar.gz \
&& (echo "$JEXTRACT_ZIP_CHECKSUM_SHA256" jextract.tar.gz | sha256sum --check --status) \
&& tar -xvzf jextract.tar.gz)

# todo: better way of finding these headers not reliant on macos/brew
echo "Finding MagickWand headers..."
IMAGEMAGICK_INCLUDES_PATH=$(find -s /opt/homebrew/Cellar/imagemagick/7*/include/ImageMagick-7 -type d -depth 0 | head -n 1)
MAGICKWAND_INCLUDES_PATH=$(find "$IMAGEMAGICK_INCLUDES_PATH" -name MagickWand -type d -depth 1 | head -n 1)
MAGICKWAND_ENTRY_PATH="$MAGICKWAND_INCLUDES_PATH"/MagickWand.h

if ! test -f "$MAGICKWAND_ENTRY_PATH"; then
  echo "Failed to find MagickWand.h" && exit 1
fi
echo "  Found ImageMagick headers at \"$IMAGEMAGICK_INCLUDES_PATH\"..."
echo "  Found MagickWand headers at \"$MAGICKWAND_INCLUDES_PATH\"..."

echo "Running jextract..."
# https://imagemagick.org/api/magick-wand.php
# https://imagemagick.org/api/magick-image.php
# https://imagemagick.org/api/magick-property.php

"$JEXTRACT_DOWNLOAD_PATH"/bin/jextract \
--define-macro MAGICKCORE_HDRI_ENABLE \
--include-dir "$IMAGEMAGICK_INCLUDES_PATH" \
--include-constant "ExceptionType" \
--include-constant "FilterType" \
--include-constant "LanczosFilter" \
--include-function "ClearMagickWand" \
--include-function "CloneMagickWand" \
--include-function "DestroyMagickWand" \
--include-function "IsMagickWand" \
--include-function "MagickClearException" \
--include-function "MagickGetException" \
--include-function "MagickGetExceptionType" \
--include-function "MagickGetIteratorIndex" \
--include-function "MagickQueryConfigureOption" \
--include-function "MagickQueryConfigureOptions" \
--include-function "MagickQueryFontMetrics" \
--include-function "MagickQueryMultilineFontMetrics" \
--include-function "MagickQueryFonts" \
--include-function "MagickQueryFormats" \
--include-function "MagickRelinquishMemory" \
--include-function "MagickResetIterator" \
--include-function "MagickSetFirstIterator" \
--include-function "MagickSetIteratorIndex" \
--include-function "MagickSetLastIterator" \
--include-function "MagickWandGenesis" \
--include-function "MagickWandTerminus" \
--include-function "NewMagickWand" \
--include-function "NewMagickWandFromImage" \
--include-function "GetImageFromMagickWand" \
--include-function "MagickAdaptiveBlurImage" \
--include-function "MagickAdaptiveResizeImage" \
--include-function "MagickAdaptiveSharpenImage" \
--include-function "MagickAdaptiveThresholdImage" \
--include-function "MagickAddImage" \
--include-function "MagickAddNoiseImage" \
--include-function "MagickAffineTransformImage" \
--include-function "MagickAnnotateImage" \
--include-function "MagickAnimateImages" \
--include-function "MagickAppendImages" \
--include-function "MagickAutoGammaImage" \
--include-function "MagickAutoLevelImage" \
--include-function "MagickAutoOrientImage" \
--include-function "MagickAutoThresholdImage" \
--include-function "MagickBilateralBlurImage" \
--include-function "MagickBlackThresholdImage" \
--include-function "MagickBlueShiftImage" \
--include-function "MagickBlurImage" \
--include-function "MagickBorderImage" \
--include-function "MagickBrightnessContrastImage" \
--include-function "MagickCannyEdgeImage" \
--include-function "MagickChannelFxImage" \
--include-function "MagickCharcoalImage" \
--include-function "MagickChopImage" \
--include-function "MagickCLAHEImage" \
--include-function "MagickClampImage" \
--include-function "MagickClipImage" \
--include-function "MagickClipImagePath" \
--include-function "MagickClutImage" \
--include-function "MagickCoalesceImages" \
--include-function "MagickColorDecisionListImage" \
--include-function "MagickColorizeImage" \
--include-function "MagickColorMatrixImage" \
--include-function "MagickColorThresholdImage" \
--include-function "MagickCombineImages" \
--include-function "MagickCommentImage" \
--include-function "MagickCompareImagesLayers" \
--include-function "MagickCompareImages" \
--include-function "MagickComplexImages" \
--include-function "MagickCompositeImage" \
--include-function "MagickCompositeImageGravity" \
--include-function "MagickCompositeLayers" \
--include-function "MagickConnectedComponentsImage" \
--include-function "MagickContrastImage" \
--include-function "MagickContrastStretchImage" \
--include-function "MagickConvolveImage" \
--include-function "MagickCropImage" \
--include-function "MagickCycleColormapImage" \
--include-function "MagickConstituteImage" \
--include-function "MagickDecipherImage" \
--include-function "MagickDeconstructImages" \
--include-function "MagickDeskewImage" \
--include-function "MagickDespeckleImage" \
--include-function "MagickDestroyImage" \
--include-function "MagickDisplayImage" \
--include-function "MagickDisplayImages" \
--include-function "MagickDistortImage" \
--include-function "MagickDrawImage" \
--include-function "MagickEdgeImage" \
--include-function "MagickEmbossImage" \
--include-function "MagickEncipherImage" \
--include-function "MagickEnhanceImage" \
--include-function "MagickEqualizeImage" \
--include-function "MagickEvaluateImage" \
--include-function "MagickExportImagePixels" \
--include-function "MagickExtentImage" \
--include-function "MagickFlipImage" \
--include-function "MagickFloodfillPaintImage" \
--include-function "MagickFlopImage" \
--include-function "MagickForwardFourierTransformImage" \
--include-function "MagickFrameImage" \
--include-function "MagickFunctionImage" \
--include-function "MagickFxImage" \
--include-function "MagickGammaImage" \
--include-function "MagickGaussianBlurImage" \
--include-function "MagickGetImage" \
--include-function "MagickGetImageAlphaChannel" \
--include-function "MagickGetImageMask" \
--include-function "MagickGetImageBackgroundColor" \
--include-function "MagickGetImageBlob" \
--include-function "MagickGetImagesBlob" \
--include-function "MagickGetImageBluePrimary" \
--include-function "MagickGetImageBorderColor" \
--include-function "MagickGetImageFeatures" \
--include-function "MagickGetImageKurtosis" \
--include-function "MagickGetImageMean" \
--include-function "MagickGetImageRange" \
--include-function "MagickGetImageStatistics" \
--include-function "MagickGetImageColormapColor" \
--include-function "MagickGetImageColors" \
--include-function "MagickGetImageColorspace" \
--include-function "MagickGetImageCompose" \
--include-function "MagickGetImageCompression" \
--include-function "MagickGetImageCompressionQuality" \
--include-function "MagickGetImageDelay" \
--include-function "MagickGetImageDepth" \
--include-function "MagickGetImageDispose" \
--include-function "MagickGetImageDistortion" \
--include-function "MagickGetImageDistortions" \
--include-function "MagickGetImageEndian" \
--include-function "MagickGetImageFilename" \
--include-function "MagickGetImageFilter" \
--include-function "MagickGetImageFormat" \
--include-function "MagickGetImageFuzz" \
--include-function "MagickGetImageGamma" \
--include-function "MagickGetImageGravity" \
--include-function "MagickGetImageGreenPrimary" \
--include-function "MagickGetImageHeight" \
--include-function "MagickGetImageHistogram" \
--include-function "MagickGetImageInterlaceScheme" \
--include-function "MagickGetImageInterpolateMethod" \
--include-function "MagickGetImageIterations" \
--include-function "MagickGetImageLength" \
--include-function "MagickGetImageMatteColor" \
--include-function "MagickGetImageOrientation" \
--include-function "MagickGetImagePage" \
--include-function "MagickGetImagePixelColor" \
--include-function "MagickGetImageRedPrimary" \
--include-function "MagickGetImageRegion" \
--include-function "MagickGetImageRenderingIntent" \
--include-function "MagickGetImageResolution" \
--include-function "MagickGetImageScene" \
--include-function "MagickGetImageSignature" \
--include-function "MagickGetImageTicksPerSecond" \
--include-function "MagickGetImageType" \
--include-function "MagickGetImageUnits" \
--include-function "MagickGetImageVirtualPixelMethod" \
--include-function "MagickGetImageWhitePoint" \
--include-function "MagickGetImageWidth" \
--include-function "MagickGetNumberImages" \
--include-function "MagickGetImageTotalInkDensity" \
--include-function "MagickHaldClutImage" \
--include-function "MagickHasNextImage" \
--include-function "MagickHasPreviousImage" \
--include-function "MagickHoughLineImage" \
--include-function "MagickIdentifyImage" \
--include-function "MagickIdentifyImageType" \
--include-function "MagickImplodeImage" \
--include-function "MagickImportImagePixels" \
--include-function "MagickInterpolativeResizeImage" \
--include-function "MagickInverseFourierTransformImage" \
--include-function "MagickKmeansImage" \
--include-function "MagickKuwaharaImage" \
--include-function "MagickLabelImage" \
--include-function "MagickLevelImage" \
--include-function "MagickLevelImageColors" \
--include-function "MagickLevelizeImage" \
--include-function "MagickLinearStretchImage" \
--include-function "MagickLiquidRescaleImage" \
--include-function "MagickLocalContrastImage" \
--include-function "MagickMagnifyImage" \
--include-function "MagickMeanShiftImage" \
--include-function "MagickMergeImageLayers" \
--include-function "MagickMinifyImage" \
--include-function "MagickModulateImage" \
--include-function "MagickMontageImage" \
--include-function "MagickMorphImages" \
--include-function "MagickMorphologyImage" \
--include-function "MagickMotionBlurImage" \
--include-function "MagickNegateImage" \
--include-function "MagickNewImage" \
--include-function "MagickNextImage" \
--include-function "MagickNormalizeImage" \
--include-function "MagickOilPaintImage" \
--include-function "MagickOpaquePaintImage" \
--include-function "MagickOptimizeImageLayers" \
--include-function "MagickOptimizeImageTransparency" \
--include-function "MagickOrderedDitherImage" \
--include-function "MagickPingImage" \
--include-function "MagickPingImageBlob" \
--include-function "MagickPingImageFile" \
--include-function "MagickPolaroidImage" \
--include-function "MagickPolynomialImage" \
--include-function "MagickPosterizeImage" \
--include-function "MagickPreviewImages" \
--include-function "MagickPreviousImage" \
--include-function "MagickQuantizeImage" \
--include-function "MagickQuantizeImages" \
--include-function "MagickRangeThresholdImage" \
--include-function "MagickRotationalBlurImage" \
--include-function "MagickRaiseImage" \
--include-function "MagickRandomThresholdImage" \
--include-function "MagickReadImage" \
--include-function "MagickReadImageBlob" \
--include-function "MagickReadImageFile" \
--include-function "MagickRemapImage" \
--include-function "MagickRemoveImage" \
--include-function "MagickResampleImage" \
--include-function "MagickResetImagePage" \
--include-function "MagickResizeImage" \
--include-function "MagickRollImage" \
--include-function "MagickRotateImage" \
--include-function "MagickSampleImage" \
--include-function "MagickScaleImage" \
--include-function "MagickSegmentImage" \
--include-function "MagickSelectiveBlurImage" \
--include-function "MagickSeparateImage" \
--include-function "MagickSepiaToneImage" \
--include-function "MagickSetImage" \
--include-function "MagickSetImageAlphaChannel" \
--include-function "MagickSetImageBackgroundColor" \
--include-function "MagickSetImageBluePrimary" \
--include-function "MagickSetImageBorderColor" \
--include-function "MagickSetImageChannelMask" \
--include-function "MagickSetImageMask" \
--include-function "MagickSetImageColor" \
--include-function "MagickSetImageColormapColor" \
--include-function "MagickSetImageColorspace" \
--include-function "MagickSetImageCompose" \
--include-function "MagickSetImageCompression" \
--include-function "MagickSetImageCompressionQuality" \
--include-function "MagickSetImageDelay" \
--include-function "MagickSetImageDepth" \
--include-function "MagickSetImageDispose" \
--include-function "MagickSetImageEndian" \
--include-function "MagickSetImageExtent" \
--include-function "MagickSetImageFilename" \
--include-function "MagickSetImageFilter" \
--include-function "MagickSetImageFormat" \
--include-function "MagickSetImageFuzz" \
--include-function "MagickSetImageGamma" \
--include-function "MagickSetImageGravity" \
--include-function "MagickSetImageGreenPrimary" \
--include-function "MagickSetImageInterlaceScheme" \
--include-function "MagickSetImageInterpolateMethod" \
--include-function "MagickSetImageIterations" \
--include-function "MagickSetImageMatte" \
--include-function "MagickSetImageMatteColor" \
--include-function "MagickSetImageAlpha" \
--include-function "MagickSetImageOrientation" \
--include-function "MagickSetImagePage" \
--include-function "MagickSetImagePixelColor" \
--include-function "MagickSetImageProgressMonitor" \
--include-function "MagickSetImageRedPrimary" \
--include-function "MagickSetImageRenderingIntent" \
--include-function "MagickSetImageResolution" \
--include-function "MagickSetImageScene" \
--include-function "MagickSetImageTicksPerSecond" \
--include-function "MagickSetImageType" \
--include-function "MagickSetImageUnits" \
--include-function "MagickSetImageVirtualPixelMethod" \
--include-function "MagickSetImageWhitePoint" \
--include-function "MagickShadeImage" \
--include-function "MagickShadowImage" \
--include-function "MagickSharpenImage" \
--include-function "MagickShaveImage" \
--include-function "MagickShearImage" \
--include-function "MagickSigmoidalContrastImage" \
--include-function "MagickSimilarityImage" \
--include-function "MagickSketchImage" \
--include-function "MagickSmushImages" \
--include-function "MagickSolarizeImage" \
--include-function "MagickSparseColorImage" \
--include-function "MagickSpliceImage" \
--include-function "MagickSpreadImage" \
--include-function "MagickStatisticImage" \
--include-function "MagickSteganoImage" \
--include-function "MagickStereoImage" \
--include-function "MagickStripImage" \
--include-function "MagickSwirlImage" \
--include-function "MagickTextureImage" \
--include-function "MagickThresholdImage" \
--include-function "MagickThumbnailImage" \
--include-function "MagickTintImage" \
--include-function "MagickTransformImageColorspace" \
--include-function "MagickTransparentPaintImage" \
--include-function "MagickTransposeImage" \
--include-function "MagickTransverseImage" \
--include-function "MagickTrimImage" \
--include-function "MagickUniqueImageColors" \
--include-function "MagickUnsharpMaskImage" \
--include-function "MagickVignetteImage" \
--include-function "MagickWaveImage" \
--include-function "MagickWaveletDenoiseImage" \
--include-function "MagickWhiteBalanceImage" \
--include-function "MagickWhiteThresholdImage" \
--include-function "MagickWriteImage" \
--include-function "MagickWriteImageFile" \
--include-function "MagickWriteImages" \
--include-typedef "MagickBooleanType" \
--include-function "MagickDeleteImageArtifact" \
--include-function "MagickDeleteImageProperty" \
--include-function "MagickDeleteOption" \
--include-function "MagickGetAntialias" \
--include-function "MagickGetBackgroundColor" \
--include-function "MagickGetColorspace" \
--include-function "MagickGetCompression" \
--include-function "MagickGetCompressionQuality" \
--include-function "MagickGetCopyright" \
--include-function "MagickGetFilename" \
--include-function "MagickGetFont" \
--include-function "MagickGetFormat" \
--include-function "MagickGetFilter" \
--include-function "MagickGetGravity" \
--include-function "MagickGetHomeURL" \
--include-function "MagickGetImageArtifact" \
--include-function "MagickGetImageArtifacts" \
--include-function "MagickGetImageProfile" \
--include-function "MagickGetImageProfiles" \
--include-function "MagickGetImageProperty" \
--include-function "MagickGetImageProperties" \
--include-function "MagickGetInterlaceScheme" \
--include-function "MagickGetInterpolateMethod" \
--include-function "MagickGetOption" \
--include-function "MagickGetOptions" \
--include-function "MagickGetOrientation" \
--include-function "MagickGetPackageName" \
--include-function "MagickGetPage" \
--include-function "MagickGetPointsize" \
--include-function "MagickGetQuantumDepth" \
--include-function "MagickGetQuantumRange" \
--include-function "MagickGetReleaseDate" \
--include-function "MagickGetResolution" \
--include-function "MagickGetResource" \
--include-function "MagickGetResourceLimit" \
--include-function "MagickGetSamplingFactors" \
--include-function "MagickGetSize" \
--include-function "MagickGetSizeOffset" \
--include-function "MagickGetType" \
--include-function "MagickGetVersion" \
--include-function "MagickProfileImage" \
--include-function "MagickRemoveImageProfile" \
--include-function "MagickSetAntialias" \
--include-function "MagickSetBackgroundColor" \
--include-function "MagickSetColorspace" \
--include-function "MagickSetCompression" \
--include-function "MagickSetCompressionQuality" \
--include-function "MagickSetDepth" \
--include-function "MagickSetExtract" \
--include-function "MagickSetFilename" \
--include-function "MagickSetFont" \
--include-function "MagickSetFormat" \
--include-function "MagickSetFilter" \
--include-function "MagickSetGravity" \
--include-function "MagickSetImageArtifact" \
--include-function "MagickSetImageProfile" \
--include-function "MagickSetImageProperty" \
--include-function "MagickSetInterlaceScheme" \
--include-function "MagickSetInterpolateMethod" \
--include-function "MagickSetOption" \
--include-function "MagickSetOrientation" \
--include-function "MagickSetPage" \
--include-function "MagickSetPassphrase" \
--include-function "MagickSetPointsize" \
--include-function "MagickSetProgressMonitor" \
--include-function "MagickSetResourceLimit" \
--include-function "MagickSetResolution" \
--include-function "MagickSetSamplingFactors" \
--include-function "MagickSetSeed" \
--include-function "MagickSetSecurityPolicy" \
--include-function "MagickSetSize" \
--include-function "MagickSetSizeOffset" \
--output lib/src/main/java \
--target-package "app.photofox.imffm.generated" \
--library "MagickWand-7.Q16HDRI" \
"$MAGICKWAND_ENTRY_PATH"
